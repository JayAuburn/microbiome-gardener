# Drizzle Rollback Workflow Guide

## Overview

This guide explains how to use our custom rollback system for Drizzle migrations while waiting for official v1.0 support.

## üîÑ Workflow

### 1. Create Migration (Normal Process)

```bash
# Make changes to your schema
# lib/drizzle/schema/users.ts

# Generate migration
npm run db:generate

# This creates:
# drizzle/migrations/0001_amazing_spider_man/migration.sql
# drizzle/migrations/0001_amazing_spider_man/snapshot.json
```

### 2. Create Down Migration (Manual)

For each generated migration, create a corresponding `down.sql` file:

```bash
# Example structure:
drizzle/migrations/0001_amazing_spider_man/
‚îú‚îÄ‚îÄ migration.sql     # ‚úÖ Generated by Drizzle
‚îú‚îÄ‚îÄ snapshot.json     # ‚úÖ Generated by Drizzle  
‚îî‚îÄ‚îÄ down.sql         # ‚ùó Create this manually
```

### 3. Write Down Migration SQL

**Example 1: Create Table ‚Üí Drop Table**
```sql
-- migration.sql (generated)
CREATE TABLE "posts" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  "title" text NOT NULL,
  "content" text,
  "created_at" timestamp DEFAULT now()
);

-- down.sql (manual)
DROP TABLE IF EXISTS "posts";
```

**Example 2: Add Column ‚Üí Drop Column**
```sql
-- migration.sql (generated)
ALTER TABLE "users" ADD COLUMN "avatar_url" text;

-- down.sql (manual)
ALTER TABLE "users" DROP COLUMN IF EXISTS "avatar_url";
```

**Example 3: Complex Migration**
```sql
-- migration.sql (generated)
ALTER TABLE "users" ADD COLUMN "email_verified" boolean DEFAULT false;
CREATE INDEX "idx_users_email_verified" ON "users" ("email_verified");
UPDATE "users" SET "email_verified" = true WHERE "email" IS NOT NULL;

-- down.sql (manual)
DROP INDEX IF EXISTS "idx_users_email_verified";
ALTER TABLE "users" DROP COLUMN IF EXISTS "email_verified";
```

### 4. Apply Migration

```bash
# Apply the up migration
npm run db:migrate
```

### 5. Rollback (If Needed)

```bash
# Rollback the last migration
npm run db:rollback
```

## üìã Available Commands

| Command | Description |
|---------|-------------|
| `npm run db:generate` | Generate new migration files |
| `npm run db:migrate` | Apply pending migrations |
| `npm run db:rollback` | Rollback the last migration |
| `npm run db:studio` | Open Drizzle Studio |

## üéØ Best Practices

### 1. **Always Create Down Migrations**
- Create `down.sql` immediately after generating a migration
- Test the down migration on a copy of your data
- Keep down migrations simple and safe

### 2. **Use Safe SQL Patterns**
```sql
-- ‚úÖ Good: Safe patterns
DROP TABLE IF EXISTS "table_name";
ALTER TABLE "users" DROP COLUMN IF EXISTS "column_name";
DROP INDEX IF EXISTS "index_name";

-- ‚ùå Avoid: Unsafe patterns  
DROP TABLE "table_name";  -- Will fail if table doesn't exist
```

### 3. **Document Complex Rollbacks**
```sql
-- down.sql
-- IMPORTANT: This rollback will lose data in the 'email_verified' column
-- Make sure to backup before running this rollback

DROP INDEX IF EXISTS "idx_users_email_verified";
ALTER TABLE "users" DROP COLUMN IF EXISTS "email_verified";
```

### 4. **Test Rollbacks in Development**
```bash
# Development workflow
npm run db:migrate     # Apply migration
npm run db:rollback    # Test rollback
npm run db:migrate     # Re-apply migration
```

## ‚ö†Ô∏è Limitations & Considerations

### 1. **Data Loss Scenarios**
Some operations cannot be safely rolled back:
- Dropping columns with data
- Changing column types  
- Complex data transformations

### 2. **Manual Process**
- Down migrations must be written manually
- No automatic generation of rollback SQL
- Requires discipline to maintain

### 3. **Single Migration Rollback**
- Current script only rolls back the last migration
- For multiple rollbacks, run the command multiple times

## üîß Advanced Usage

### Rolling Back Multiple Migrations

```bash
# Rollback last 3 migrations
npm run db:rollback
npm run db:rollback  
npm run db:rollback
```

### Checking Current Migration

The rollback script will show you:
- Current migration hash
- Migration folder path
- SQL being executed

### Custom Rollback Logic

For complex scenarios, you can modify `scripts/rollback.ts` to:
- Add confirmation prompts
- Support rolling back to a specific migration
- Add backup creation before rollback

## üöÄ Future Migration Path

When Drizzle v1.0 releases with official rollback support:
1. The migration structure should be compatible
2. You can migrate to official tooling
3. Existing down migrations can likely be preserved

## üìö Resources

- [Original GitHub Discussion](https://github.com/drizzle-team/drizzle-orm/discussions/1339)
- [Drizzle Migrations Docs](https://orm.drizzle.team/docs/migrations)
- [Community Solutions](https://github.com/drepkovsky/drizzle-migrations)

---

**Remember**: This is a temporary solution while waiting for official support. Always test rollbacks in development before using in production! 
