# Fix Google Cloud Storage Authentication and Environment Configuration

> **Task Type:** Bug Fix & Configuration  
> **Priority:** High  
> **Estimated Time:** 2-3 hours

---

## 1. Task Overview

### Task Title
**Fix Google Cloud Storage Authentication and Environment Configuration**

### Goal Statement
**Goal:** Resolve all Google Cloud authentication errors preventing the document upload system from functioning. The system currently has multiple authentication-related TypeScript errors due to missing environment variables and inconsistent credential handling. We need to implement a robust, production-ready authentication system that works both locally and in deployment environments.

---

## 2. Project Analysis & Current State

### Technology & Architecture
- **Frameworks & Versions:** Next.js 15.3, React 19
- **Language:** TypeScript 5.4 with strict mode
- **Database & ORM:** Supabase (Postgres) via Drizzle ORM
- **UI & Styling:** shadcn/ui components with Tailwind CSS for styling
- **Authentication:** Supabase Auth managed by `middleware.ts` for protected routes
- **Key Architectural Patterns:** Next.js App Router, Server Components for data fetching, Server Actions for mutations
- **Cloud Services:** Google Cloud Storage for file uploads, Google Cloud AI for processing
- **Relevant Existing Components:** 
  - `lib/google-cloud.ts` - Google Cloud Storage client (currently broken)
  - `lib/gemini-client.ts` - Google AI client (missing credentials)
  - `lib/env.ts` - Environment configuration (incomplete)

### Current State
**Current Issues Based on TypeScript Analysis:**

1. **Missing Environment Variables (9 TypeScript errors):**
   - `GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY` - Removed from env.ts but still referenced
   - `GOOGLE_CLOUD_ACCESS_TOKEN` - Missing from env.ts, used in gemini-client.ts and search API
   - `embedding` field missing from document_chunks schema

2. **Inconsistent Authentication Patterns:**
   - `lib/google-cloud.ts` tries to use service account key that doesn't exist
   - `lib/gemini-client.ts` expects access token authentication
   - `app/api/search/route.ts` references missing embedding field

3. **Environment Configuration Gaps:**
   - User removed `GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY` from env.ts
   - No fallback to Application Default Credentials
   - Missing access token configuration for AI services

**Files Currently Broken:**
- `lib/google-cloud.ts` (2 errors)
- `lib/gemini-client.ts` (3 errors)
- `app/api/search/route.ts` (4 errors)

## 3. Context & Problem Definition

### Problem Statement
The document upload system is completely non-functional due to authentication configuration errors. Users cannot upload documents because:

1. **Storage Authentication Failure:** Google Cloud Storage client cannot initialize due to missing credentials
2. **AI Service Authentication Failure:** Gemini client cannot authenticate for embeddings and search
3. **Database Schema Mismatch:** Search API expects embedding field that doesn't exist
4. **Environment Configuration Inconsistency:** Mix of different authentication methods without proper fallbacks

This prevents the core RAG (Retrieval-Augmented Generation) functionality from working, which is essential for the application.

### Success Criteria
- [ ] All TypeScript compilation errors resolved
- [ ] Google Cloud Storage client successfully initializes and can generate signed URLs
- [ ] Gemini client can authenticate and generate embeddings
- [ ] Search API works with proper embedding field
- [ ] Environment configuration supports multiple authentication methods
- [ ] System works both locally (with service account key) and in production (with ADC)
- [ ] All authentication errors are properly handled and logged

---

## 4. Technical Requirements

### Functional Requirements
- **Storage Upload:** Users can upload documents via signed URLs generated by authenticated GCS client
- **AI Processing:** System can authenticate with Google AI services for embeddings and processing
- **Search Functionality:** Vector search works with proper embedding field access
- **Environment Flexibility:** System supports multiple authentication methods based on deployment environment

### Non-Functional Requirements
- **Security:** Service account keys are stored securely as environment variables, never in code
- **Performance:** Authentication initialization happens once per request cycle
- **Reliability:** Graceful fallbacks when primary authentication method fails
- **Responsive Design:** Must work on mobile (320px+), tablet (768px+), and desktop (1024px+)
- **Theme Support:** Must support both light and dark mode using existing theme system
- **Compatibility:** Works in both development and production environments

### Technical Constraints
- **Must use existing authentication patterns** where possible
- **Cannot modify database schema** without proper migration
- **Must maintain backward compatibility** with existing upload flow
- **Must not expose credentials** in client-side code

---

## 5. Data & Database Changes

### Database Schema Changes
**Required: Add embedding field to document_chunks table**

```sql
-- Add embedding vector field for similarity search
ALTER TABLE document_chunks 
ADD COLUMN embedding vector(1536);

-- Add index for vector similarity search
CREATE INDEX document_chunks_embedding_idx ON document_chunks 
USING ivfflat (embedding vector_cosine_ops);
```

### Data Model Updates
**Update document_chunks schema in Drizzle:**

```typescript
// lib/drizzle/schema/document_chunks.ts
export const documentChunks = pgTable('document_chunks', {
  id: uuid('id').primaryKey().defaultRandom(),
  document_id: uuid('document_id').references(() => documents.id, { onDelete: 'cascade' }),
  chunk_index: integer('chunk_index').notNull(),
  content: text('content').notNull(),
  metadata: jsonb('metadata'),
  // Add embedding field for vector search
  embedding: vector('embedding', { dimensions: 1536 }),
  created_at: timestamp('created_at').defaultNow(),
  updated_at: timestamp('updated_at').defaultNow(),
});
```

### Data Migration Plan
- [ ] Create migration to add embedding field
- [ ] Create vector similarity index
- [ ] Ensure existing data remains functional
- [ ] Test vector search functionality

---

## 6. API & Backend Changes

### Data Access Pattern - CRITICAL ARCHITECTURE RULES
Following existing project patterns:

**MUTATIONS (Server Actions)** â†’ `app/actions/[feature].ts`
- [ ] **No changes needed** - Document upload already handled in actions

**QUERIES (Data Fetching)** â†’ Direct in Server Components
- [ ] **Search API** - Update to use proper embedding field access
- [ ] **Direct queries** - Already working correctly

### Authentication Configuration Updates
**Environment Variables - Multiple Authentication Methods:**

```typescript
// lib/env.ts - Support flexible authentication
server: {
  // ... existing variables ...
  
  // Google Cloud Authentication (choose one method)
  GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY: z.string().optional(),
  GOOGLE_CLOUD_ACCESS_TOKEN: z.string().optional(),
  
  // Or use Application Default Credentials (no env var needed)
  // Automatically detected in production environments
}
```

### Google Cloud Client Updates
**Flexible Authentication Strategy:**

```typescript
// lib/google-cloud.ts - Support multiple auth methods
const storage = new Storage({
  projectId: env.GOOGLE_CLOUD_PROJECT_ID,
  // Priority order: 1) Service Account Key, 2) ADC
  ...(env.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY && {
    credentials: JSON.parse(env.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY),
  }),
  // If no service account key, use Application Default Credentials
});
```

### API Routes Updates
- [ ] **Search API** - Fix embedding field access
- [ ] **Upload URL API** - Already working, no changes needed

### External Integrations
- **Google Cloud Storage:** File uploads and management
- **Google AI Platform:** Embeddings and text processing
- **Vertex AI:** Advanced AI capabilities

---

## 7. Frontend Changes

### New Components
**No new components needed** - Authentication is backend-only

### Page Updates
**No page updates needed** - Frontend already handles upload correctly

### State Management
**No state management changes** - Authentication happens server-side

---

## 8. Implementation Plan

### Phase 1: Environment Configuration Fix
**Goal:** Resolve all environment variable issues

- [ ] **Task 1.1:** Update env.ts with flexible authentication options
  - Files: `lib/env.ts`
  - Details: Add optional GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY and GOOGLE_CLOUD_ACCESS_TOKEN
- [ ] **Task 1.2:** Update google-cloud.ts to support multiple auth methods
  - Files: `lib/google-cloud.ts`
  - Details: Implement priority-based authentication (service account key â†’ ADC)
- [ ] **Task 1.3:** Update gemini-client.ts for proper authentication
  - Files: `lib/gemini-client.ts`
  - Details: Use consistent authentication pattern

### Phase 2: Database Schema Fix
**Goal:** Add missing embedding field

- [ ] **Task 2.1:** Create migration for embedding field
  - Files: `drizzle/migrations/`, `lib/drizzle/schema/document_chunks.ts`
  - Details: Add vector embedding field with proper indexing
- [ ] **Task 2.2:** Update document_chunks schema
  - Files: `lib/drizzle/schema/document_chunks.ts`
  - Details: Add embedding field definition
- [ ] **Task 2.3:** Run migration and verify schema
  - Files: N/A
  - Details: Test database migration and verify field exists

### Phase 3: API Fixes
**Goal:** Fix all API authentication and data access issues

- [ ] **Task 3.1:** Fix search API embedding field access
  - Files: `app/api/search/route.ts`
  - Details: Update to use proper embedding field from schema
- [ ] **Task 3.2:** Test all API endpoints
  - Files: All API routes
  - Details: Verify authentication works and APIs respond correctly
- [ ] **Task 3.3:** Add error handling and logging
  - Files: `lib/google-cloud.ts`, `lib/gemini-client.ts`
  - Details: Proper error messages for authentication failures

### Phase 4: Testing & Validation
**Goal:** Ensure everything works in all environments

- [ ] **Task 4.1:** Test local development setup
  - Files: N/A
  - Details: Verify works with service account key
- [ ] **Task 4.2:** Test production deployment setup
  - Files: N/A
  - Details: Verify works with Application Default Credentials
- [ ] **Task 4.3:** End-to-end testing
  - Files: N/A
  - Details: Test complete upload â†’ processing â†’ search flow

---

## 9. File Structure & Organization

### New Files to Create
```
apps/web/
â”œâ”€â”€ drizzle/migrations/
â”‚   â””â”€â”€ 0011_add_embedding_field.sql        # New migration for embedding field
â””â”€â”€ lib/
    â””â”€â”€ authentication-utils.ts              # Optional: Centralized auth utilities
```

### Files to Modify
- [ ] **`lib/env.ts`** - Add missing environment variables with optional flags
- [ ] **`lib/google-cloud.ts`** - Fix authentication to support multiple methods
- [ ] **`lib/gemini-client.ts`** - Update authentication pattern
- [ ] **`lib/drizzle/schema/document_chunks.ts`** - Add embedding field
- [ ] **`app/api/search/route.ts`** - Fix embedding field access
- [ ] **`drizzle.config.ts`** - Ensure proper migration configuration

### Dependencies to Add
**No new dependencies needed** - Using existing Google Cloud SDK

---

## 10. Error Handling & Edge Cases

### Error Scenarios
- [ ] **Authentication Failure:** Service account key is invalid or expired
  - **Handling:** Log error, fallback to ADC, return user-friendly message
- [ ] **Missing Environment Variables:** Required variables not set
  - **Handling:** Clear error message indicating which variables are missing
- [ ] **Network Connectivity:** Cannot reach Google Cloud services
  - **Handling:** Retry with backoff, clear error message
- [ ] **Database Migration Failure:** Embedding field cannot be added
  - **Handling:** Rollback migration, clear error message

### Edge Cases
- [ ] **Multiple Authentication Methods:** Both service account key and ADC available
  - **Solution:** Use priority order (service account key takes precedence)
- [ ] **Large Embedding Vectors:** Vector dimension mismatch
  - **Solution:** Validate embedding dimensions before storage
- [ ] **Concurrent Uploads:** Multiple users uploading simultaneously
  - **Solution:** Ensure thread-safe authentication initialization

---

## 11. Security Considerations

### Authentication & Authorization
- [ ] **Service account keys are never exposed** in client-side code
- [ ] **Environment variables are properly secured** in deployment
- [ ] **Fallback authentication methods** don't compromise security
- [ ] **Token rotation** is handled gracefully

### Input Validation
- [ ] **Environment variable validation** ensures proper format
- [ ] **Service account key validation** ensures valid JSON structure
- [ ] **Authentication token validation** before use

---

## 12. Deployment & Configuration

### Environment Variables
**Development (.env.local):**
```bash
# Google Cloud Authentication (choose one)
GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY='{"type":"service_account","project_id":"...","private_key":"..."}'

# Or use Application Default Credentials
# gcloud auth application-default login

# Required for all environments
GOOGLE_CLOUD_PROJECT_ID=your-project-id
GOOGLE_CLOUD_STORAGE_BUCKET=your-bucket-name
GOOGLE_CLOUD_REGION=us-central1
```

**Production:**
```bash
# Use Application Default Credentials when possible
# Or set service account key as environment variable
GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY='{"type":"service_account",...}'
```

---

## 13. AI Agent Instructions

### Default Workflow - TASK DOCUMENTATION FIRST
âœ… **TASK DOCUMENT CREATED** - This document serves as the comprehensive implementation plan.

### Communication Preferences
- [ ] **Ask for clarification** if authentication method preference is unclear
- [ ] **Provide progress updates** after each phase completion
- [ ] **Flag any security concerns** immediately
- [ ] **Test thoroughly** in both development and production-like environments

### Implementation Approach - CRITICAL WORKFLOW
ðŸš¨ **MANDATORY: Follow this exact sequence:**

1. **âœ… TASK DOCUMENT CREATED** - This comprehensive plan is now complete
2. **GET APPROVAL SECOND (Required)**
   - [ ] **Wait for explicit user approval** before implementing any changes
   - [ ] **Confirm authentication method preference** (service account key vs ADC)
   - [ ] **Verify environment variable approach** is acceptable
3. **IMPLEMENT THIRD (Only after approval)**
   - [ ] Start with Phase 1 (Environment Configuration) and complete fully
   - [ ] **Test authentication** before proceeding to Phase 2
   - [ ] **Validate each phase** before moving to next
   - [ ] **Run TypeScript compilation** after each major change

### Code Quality Standards
- [ ] **Use existing patterns** from the codebase
- [ ] **Add comprehensive error handling** for all authentication failures
- [ ] **Include detailed logging** for debugging authentication issues
- [ ] **Test in both light and dark mode** (minimal impact expected)
- [ ] **Ensure mobile compatibility** (backend changes only)
- [ ] **Follow TypeScript strict mode** requirements

---

## 14. Notes & Additional Context

### Research Findings from Context7
**Google Cloud Node.js Authentication Methods:**

1. **Service Account Key (Recommended for this project):**
   ```javascript
   const storage = new Storage({
     projectId: 'your-project-id',
     credentials: JSON.parse(process.env.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY)
   });
   ```

2. **Application Default Credentials (Best for production):**
   ```javascript
   const storage = new Storage({
     projectId: 'your-project-id'
     // Automatically uses ADC
   });
   ```

3. **Priority-based Authentication (Our approach):**
   ```javascript
   const storage = new Storage({
     projectId: env.GOOGLE_CLOUD_PROJECT_ID,
     ...(env.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY && {
       credentials: JSON.parse(env.GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY),
     }),
   });
   ```

### Authentication Flow
1. **Check for service account key** in environment variables
2. **Use service account key** if available (development/explicit config)
3. **Fallback to ADC** if no key provided (production environments)
4. **Fail gracefully** with clear error messages

### Security Best Practices
- **Never commit service account keys** to version control
- **Use environment variables** for all sensitive configuration
- **Implement token rotation** where applicable
- **Log authentication attempts** for debugging
- **Validate authentication** before making API calls

---

*Template Version: 1.0*  
*Last Updated: [Current Date]*  
*Created By: Claude (AI Assistant)* 
